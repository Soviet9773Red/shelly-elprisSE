// @license (c) Jussi isotalo - http://jisotalo.fi https://github.com/jisotalo/shelly-porssisahko-en
// https://github.com/Soviet9773Red/shelly-elprisSE
// SE1-4 anpassad av https://github.com/Soviet9773Red 
// Thx GPT-o1 & 4o + @MikaelUlvesjo → JSON.parse++ idea
// License: GNU AGPL v3.0
var ah = 14;//API hour, use 14-23 range


const CNST={INST_COUNT:"undefined"==typeof INSTANCE_COUNT?3:INSTANCE_COUNT,HIST_LEN:"undefined"==typeof HIST_LEN?12:HIST_LEN,ERR_LIMIT:3,ERR_DELAY:120,DEF_INST_ST:{chkTs:0,st:0,str:"",cmd:-1,configOK:0,fCmdTs:0,fCmd:0},DEF_CFG:{COM:{g:"SE3",vat:0,day:0,night:0,names:[]},INST:{en:0,mode:0,m0:{c:0},m1:{l:0},m2:{p:24,c:0,l:-999,s:0,m:999,ps:0,pe:23,ps2:0,pe2:23,c2:0},b:0,e:0,o:[0],f:0,fc:0,i:0,m:60,oc:0}}};var am=Math.floor(20+Math.random()*31);let _={s:{v:"3.1.1SE",dn:"",configOK:0,timeOK:0,errCnt:0,errTs:0,upTs:0,tz:"+01:00",enCnt:0,p:[{ts:0,now:0,low:0,high:0,avg:0},{ts:0,now:0,low:0,high:0,avg:0}]},si:[CNST.DEF_INST_ST],p:[[],[]],h:[],c:{c:CNST.DEF_CFG.COM,i:[CNST.DEF_CFG.INST]}},_i=0,_j=0,_k=0,_inc=0,_cnt=0,_start=0,_end=0,cmd=[],prevEpoch=0,loopRunning=!1;function log(e){print("elpris-SE: "+e)}function loop(){try{if(!loopRunning){loopRunning=!0;updateState();if(_.s.configOK){if(pricesNeeded(0))getPrices(0);else if(pricesNeeded(1))getPrices(1);else{for(let e=0;e<CNST.INST_COUNT;e++)if(!_.si[e].configOK)return void getConfig(e);for(let e=0;e<CNST.INST_COUNT;e++)if(function(e){var t=_.si[e],s=_.c.i[e];if(1!=s.en)return void(_.h[e]=[]);var e=new Date,n=new Date(1e3*t.chkTs);return 0==t.chkTs||n.getHours()!=e.getHours()||n.getFullYear()!=e.getFullYear()||0<t.fCmdTs&&t.fCmdTs-epoch(e)<0||0==t.fCmdTs&&s.m<60&&e.getMinutes()>=s.m&&t.cmd+s.i==1}(e))return void Timer.set(500,!1,logic,e);"function"==typeof USER_LOOP&&USER_LOOP();loopRunning=!1}}else getConfig(-1)}}catch(e){log("error at main loop:"+e);loopRunning=!1}}function getKvsKey(e){let t="elpris";return t=0<=e?t+"-"+(e+1):t}function isCurrentHour(index,t){return index===t.getHours()}function limit(e,t,s){return Math.min(s,Math.max(e,t))}function epoch(e){return Math.floor((e?e.getTime():Date.now())/1e3)}function getDate(e){return e.getDate()}function updateTz(e){let t=e.toString(),s=0;"+0000"==(t=t.substring(3+t.indexOf("GMT")))?(t="Z",s=0):(s=+t.substring(0,3),t=t.substring(0,3)+":"+t.substring(3));t!=_.s.tz&&(_.s.p[0].ts=0);_.s.tz=t}function addHistory(e){for(var t=0<_.s.enCnt?CNST.HIST_LEN/_.s.enCnt:CNST.HIST_LEN;0<CNST.HIST_LEN&&_.h[e].length>=t;)_.h[e].splice(0,1);_.h[e].push([epoch(),cmd[e]?1:0,_.si[e].st])}function reqLogic(){for(let e=0;e<CNST.INST_COUNT;e++)_.si[e].chkTs=0}function updateState(){var e=new Date,t=(_.s.timeOK=null!=Shelly.getComponentStatus("sys").unixtime&&2e3<e.getFullYear(),_.s.dn=Shelly.getComponentConfig("sys").device.name,epoch(e));if(_.s.timeOK&&300<Math.abs(t-prevEpoch)){log("Time changed 5 min+ -> refresh");_.s.p[0].ts=0;_.s.p[0].now=0;_.s.p[1].ts=0;_.p[1]=[]}prevEpoch=t;_.s.enCnt=0;_i=0;for(;_i<CNST.INST_COUNT;_i++)_.c.i[_i].en&&_.s.enCnt++;!_.s.upTs&&_.s.timeOK&&(_.s.upTs=epoch(e))}function pricesNeeded(e){var t=new Date;let s=!1;let delayAfter404=3600;s=e==1?_.s.timeOK&&0===_.s.p[1].ts&&(t.getHours()>ah||t.getHours()===ah&&t.getMinutes()>=am):getDate(new Date(1e3*_.s.p[0].ts))!==getDate(t)&&(_.s.p[1].ts=0,_.p[1]=[],_.s.timeOK&&(0==_.s.p[0].ts||true));if(e==1&&_.s.errCnt>=CNST.ERR_LIMIT){if(epoch(t)-_.s.errTs<delayAfter404){s=!1}else{_.s.errCnt=0}}return s}let apiBurl="https://www.elprisetjustnu.se/api/v1/prices/";function bldU(dStr){let reg=_.c.c.g;if(!reg){reg="SE3"}let prt=dStr.split("-");let ar=prt[0];let mDay=prt[1]+"-"+prt[2];let url=apiBurl+ar+"/"+mDay+"_"+reg+".json";return url}function getPrices(r){try{let i=new Date;updateTz(i);let t=r===1?new Date(i.getFullYear(),i.getMonth(),i.getDate()+1):i;let yyyy=t.getFullYear();let mm=t.getMonth()+1;if(mm<10)mm="0"+mm;let dd=t.getDate();if(dd<10)dd="0"+dd;let dStr=yyyy+"-"+mm+"-"+dd;let url=bldU(dStr);let c={url:url,timeout:5,ssl_ca:"*"};log("API url: "+c.url);Shelly.call("HTTP.GET",c,function(tResp,errCode,errMsg){c=null;try{if(errCode!==0||!tResp||tResp.code!==200||!tResp.body)throw Error(errCode+"("+errMsg+") - "+JSON.stringify(tResp));let raw=JSON.parse(tResp.body);tResp.body=null;if(!raw||raw.length<23)throw Error("invalid data received: only "+(raw?raw.length:"null")+" hours");let hMarks={};for(let i=0;i<raw.length;i++){let hour=parseInt(raw[i].time_start.slice(11,13));hMarks[hour]=(hMarks[hour]||0)+1}let nT=raw.length;if(hMarks[2]===2){log("Winter time: hour 02 appears twice (25h)")}else if(!hMarks[2]){log("Summer time: hour 02 missing (23h)")}else{log("Got prices for day "+r+" and 24h")}_.s.p[r].nT=nT;_.p[r]=[];_.s.p[r].avg=0;_.s.p[r].high=-999;_.s.p[r].low=999;_.s.p[r].maxH=-1;_.s.p[r].minH=-1;for(let i=0;i<raw.length;i++){let o=raw[i];let hour=parseInt(o.time_start.slice(11,13));let price=+o.SEK_per_kWh;price+=hour>=6&&hour<22?_.c.c.day:_.c.c.night;_.p[r][hour]=price;if(price>_.s.p[r].high){_.s.p[r].high=price;_.s.p[r].maxH=hour}if(price<_.s.p[r].low){_.s.p[r].low=price;_.s.p[r].minH=hour}_.s.p[r].avg+=price}if(_.s.p[r].nT===23&&(_.p[r][2]===undefined||isNaN(_.p[r][2]))){_.p[r][2]=_.p[r][1];log("Patched missing hour 02: copied price from hour 01")}_.s.p[r].avg=Math.round(_.s.p[r].avg/_.p[r].length*1e4)/1e4;_.s.p[r].ts=epoch();o=null;raw=null}catch(err){if(errCode===404&&r===1){log("Error getting prices – will retry in about 60 minutes.");log("- Prices for tomorrow are not yet available (holiday delay?)");_.s.errTs=epoch();_.s.p[r].ts=0;_.p[r]=[];return}log("Error getting prices – general failure.");_.s.errCnt+=1;_.s.errTs=epoch();_.s.p[r].ts=0;_.p[r]=[]}if(r===0)reqLogic();loopRunning=false;Timer.set(500,false,loop)})}catch(e){log("error getting prices: "+e);_.s.errCnt+=1;_.s.errTs=epoch();_.s.p[r].ts=0;_.p[r]=[];if(r===0)reqLogic();loopRunning=false;Timer.set(500,false,loop)}}function logic(i){try{"function"==typeof USER_CONFIG&&USER_CONFIG(i,!1);cmd[i]=!1;var e,t,s=new Date;updateTz(s);!function(){if(_.s.timeOK&&0!=_.s.p[0].ts){var t=new Date;for(let e=0;e<_.p[0].length;e++)if(isCurrentHour(e,t)){_.s.p[0].now=_.p[0][e];return}_.s.timeOK=!1;_.s.p[0].ts=0;_.s.errCnt+=1;_.s.errTs=epoch()}else _.s.p[0].ts,_.s.p[0].now=0}();let n=_.si[i],o=_.c.i[i];function c(e){if(null==e)loopRunning=!1;else{if(cmd[i]!=e&&(n.st=12),cmd[i]=e,o.i&&(cmd[i]=!cmd[i]),log("logic for #"+(i+1)+" done, cmd: "+e+" -> output: "+cmd[i]),1==o.oc&&n.cmd==cmd[i]){log("outputs already set for #"+(i+1));n.cmd=cmd[i]?1:0;n.chkTs=epoch();loopRunning=!1}else{let t=0,s=0;for(let e=0;e<o.o.length;e++)!function(e,o,i){e="{id:"+o+",on:"+(cmd[e]?"true":"false")+"}";Shelly.call("Switch.Set",e,function(e,t,s,n){0!=t&&log("setting output "+o+" failed: "+t+" - "+s);n(0==t)},i)}(i,o.o[e],function(e){t++;e&&s++;t==o.o.length&&(s==t&&(addHistory(i),n.cmd=cmd[i]?1:0,n.chkTs=epoch(),Timer.set(500,!1,loop)),loopRunning=!1)})}}}0===o.mode?(cmd[i]=1===o.m0.c,n.st=1):_.s.timeOK&&0<_.s.p[0].ts&&getDate(new Date(1e3*_.s.p[0].ts))===getDate(s)?1===o.mode?(cmd[i]=_.s.p[0].now<=("avg"==o.m1.l?_.s.p[0].avg:o.m1.l),n.st=cmd[i]?2:3):2===o.mode&&(cmd[i]=function(e){var t=_.c.i[e],s=(t.m2.ps=limit(0,t.m2.ps,23),t.m2.pe=limit(t.m2.ps,t.m2.pe,24),t.m2.ps2=limit(0,t.m2.ps2,23),t.m2.pe2=limit(t.m2.ps2,t.m2.pe2,24),t.m2.c=limit(0,t.m2.c,0<t.m2.p?t.m2.p:t.m2.pe-t.m2.ps),t.m2.c2=limit(0,t.m2.c2,t.m2.pe2-t.m2.ps2),[]);for(_inc=t.m2.p<0?1:t.m2.p,_i=0;_i<_.p[0].length;_i+=_inc){if(!((_cnt=-2==t.m2.p&&1<=_i?t.m2.c2:t.m2.c)<=0)){var n=[];for(_start=_i,_end=_i+t.m2.p,t.m2.p<0&&0==_i?(_start=t.m2.ps,_end=t.m2.pe):-2==t.m2.p&&1==_i&&(_start=t.m2.ps2,_end=t.m2.pe2),_j=_start;_j<_end&&!(_j>_.p[0].length-1);_j++)n.push(_j);if(t.m2.s){for(_avg=999,_startIndex=0,_j=0;_j<=n.length-_cnt;_j++){for(_sum=0,_k=_j;_k<_j+_cnt;_k++)_sum+=_.p[0][n[_k]];_sum/_cnt<_avg&&(_avg=_sum/_cnt,_startIndex=_j)}for(_j=_startIndex;_j<_startIndex+_cnt;_j++)s.push(n[_j])}else{for(_j=0,_k=1;_k<n.length;_k++){var o=n[_k];for(_j=_k-1;0<=_j&&_.p[0][o]<_.p[0][n[_j]];_j--)n[_j+1]=n[_j];n[_j+1]=o}for(_j=0;_j<_cnt;_j++)s.push(n[_j])}if(-1==t.m2.p||-2==t.m2.p&&1<=_i)break}}let i=new Date,c=!1;for(let e=0;e<s.length;e++)if(isCurrentHour(s[e],i)){c=!0;break}return c}(i),n.st=cmd[i]?5:4,!cmd[i]&&_.s.p[0].now<=("avg"==o.m2.l?_.s.p[0].avg:o.m2.l)&&(cmd[i]=!0,n.st=6),cmd[i])&&_.s.p[0].now>("avg"==o.m2.m?_.s.p[0].avg:o.m2.m)&&(cmd[i]=!1,n.st=11):(_.s.timeOK?(n.st=7,e=1<<s.getHours(),(o.b&e)==e&&(cmd[i]=!0)):(cmd[i]=1===o.e,n.st=8),_.s.timeOK&&0<o.f&&(t=1<<s.getHours(),(o.f&t)==t)&&(cmd[i]=(o.fc&t)==t,n.st=10),cmd[i]&&_.s.timeOK&&s.getMinutes()>=o.m&&(n.st=13,cmd[i]=!1),_.s.timeOK&&0<n.fCmdTs&&(0<n.fCmdTs-epoch(s)?(cmd[i]=1==n.fCmd,n.st=9):n.fCmdTs=0)),"function"==typeof USER_OVERRIDE?USER_OVERRIDE(i,cmd[i],c):c(cmd[i])}catch(e){log("error running logic: "+JSON.stringify(e));loopRunning=!1}}let _avg=999,_startIndex=0,_sum=0;log("v."+_.s.v);log("API time: "+ah+":"+am+" | random minute 20-50");log("URL http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId());_.c.i.pop();_.si.pop();for(let e=0;e<CNST.INST_COUNT;e++){_.si.push(Object.assign({},CNST.DEF_INST_ST));_.c.i.push(Object.assign({},CNST.DEF_CFG.INST));_.c.c.names.push("-");_.h.push([]);cmd.push(!1)}function getConfig(g){var e=getKvsKey(g);Shelly.call("KVS.Get",{key:e},function(t,e,s){g<0?_.c.c=t?JSON.parse(t.value):{}:_.c.i[g]=t?JSON.parse(t.value):{};if("function"==typeof USER_CONFIG)USER_CONFIG(g,!0);{let t=g;var n=function(e){g<0?_.s.configOK=e?1:0:(log("config for #"+(g+1)+" read, enabled: "+_.c.i[g].en),_.si[g].configOK=e?1:0,_.si[g].chkTs=0),loopRunning=!1,Timer.set(500,!1,loop)};let e=0;if(CNST.DEF_CFG.COM||CNST.DEF_CFG.INST){var o,i=g<0?CNST.DEF_CFG.COM:CNST.DEF_CFG.INST,c=g<0?_.c.c:_.c.i[t];for(o in i)if(void 0===c[o])c[o]=i[o],e++;else if("object"==typeof i[o])for(var r in i[o])void 0===c[o][r]&&(c[o][r]=i[o][r],e++);t>=CNST.INST_COUNT-1&&(CNST.DEF_CFG.COM=null,CNST.DEF_CFG.INST=null);0<e?(t=getKvsKey(t),Shelly.call("KVS.Set",{key:t,value:JSON.stringify(c)},function(e,t,s,n){t&&log("failed to set config: "+t+" - "+s);n(0==t)},n)):n(!0)}else n(!0)}})}CNST.DEF_INST_ST=null;prevEpoch=epoch();HTTPServer.registerEndpoint("",function(s,n){try{if(loopRunning){s=null;n.code=503;n.send();return}var o=function(query){var t={};var pairs=query.split("&");for(let i=0;i<pairs.length;i++){var kv=pairs[i].split("=");t[kv[0]]=kv[1]}return t}(s.query);var i=parseInt(o.i);s=null;let e="application/json";n.code=200;let useGzip=true;var c="text/html";var r="text/javascript";if("s"===o.r){updateState();if(i>=0&&i<CNST.INST_COUNT){n.body=JSON.stringify({s:_.s,si:_.si[i],c:_.c.c,ci:_.c.i[i],p:_.p})}useGzip=false}else if("c"===o.r){updateState();if(i>=0&&i<CNST.INST_COUNT){n.body=JSON.stringify(_.c.i[i])}else{n.body=JSON.stringify(_.c.c)}useGzip=false}else if("h"===o.r){if(i>=0&&i<CNST.INST_COUNT){n.body=JSON.stringify(_.h[i])}useGzip=false}else if("r"===o.r){if(i>=0&&i<CNST.INST_COUNT){log("config changed for #"+(i+1));_.si[i].configOK=false}else{log("config changed");for(let e=0;e<CNST.INST_COUNT;e++){_.si[e].configOK=false}}_.s.configOK=false;reqLogic();if(!loopRunning){loopRunning=true;getConfig(i)}_.s.p[0].ts=0;_.s.p[1].ts=0;n.code=204;useGzip=false}else if("f"===o.r&&o.ts){if(i>=0&&i<CNST.INST_COUNT){_.si[i].fCmdTs=+(""+o.ts);_.si[i].fCmd=+(""+o.c);_.si[i].chkTs=0}n.code=204;useGzip=false}else if("s.js"===o.r){n.body=atob("H4sIAAAAAAAAA31Wa1PbOBT9K0JlGWli1KTdfklqMi3QbTs8Ok26MzsMswhbSVRkyUhy0kzwf98r23EMZfkAjqUr3dc551oJj358P4sxjuAxCU+pnY/7EU+8XIopvw1rqUli+CsyoX1072IfH8Eruy+EXU+EEok3luBXuOdpdPLxr5jQ+GhTRpPph+npv5Pp9/gKTzy3Xuo5YwxH+JzrgiuUmVTA2zcrE4FuhTIrpGQmfbtmlsK2SxfGI54ZPUfJQvBcOI+kRn4hHcqFlSYFm+PtTm34eLPrh6sVXztkdHv9R57cFTlKjPbWKES0QXk44CLkZSbQnTYrTcHwNBN2LnSy3tlWBoVuTZr8QvhWpgKRQnup0B8ubF5uVxemsI9Tzfgv1gb0w8GKS6zMfbW7sjJUMGTZ+M2kLryALGZ1puFCyMwKnq5R4USKr6Pzy5NtD+qoWo9bP23NwnEHR5znXsRLI1PUj44/TuKr6ygTVVcBDMqYfAr52lgXSkUmFzrAhLu1TpCAxtcH9+JYHBxgHJ4PD0TE2PPbw3B14TCNVlKnZsWUSbiXRrMFd4tY9PBr3CMBgr0B7WBQjJbcIh/fO4JxT9CRnBF/cEA8AygkdyKN9/o0wjiOK5PkMBgxqbWwn6fnZ9Tb9YavuPQoN3mhIL2TteaZTE645wTcsoXPQmXqkyUElSyIpxvosDNKMOgYQBzgDQszaTNy84lLJVLkDVKGw3MhUM7nAh0icIb4nEs9RmR/41kmnIOdkt7Qg4OmXAScFHkKgZxBOQlEX0ZiyVXoLJwUdlL1fcrnLiZNrYwOnupCVwyra/JcJZnLlfQEqgmlCoQmObdOfNGe+KvBNX14GNDDwbZ3sNa/Zk4BKMiAAoVP/x5bcf8VKpmKJfsJ/Rp2goVQf2P/B6UIZh4s2czYUx6qFx95xtP0dAmqcSadF5AW9GbB9RxYD9ub1j8DdZgLz2RKSwgALg1S8yUFG7iOhERrIrjQ33abPhNEbQcIk3F/JN83x5gSeu4XI9nr0WbpSl7XCJmKX34cik+e26HDmQhg6Ow5m1AGDddkVugkFJ1AcTjdhP/MwyHydN/STeXBQn4ljTqXQWMglwtQQmZFBjw/XkiVdtwF+2dQ2+DARyJAAVoGJPNxUPEeHtsYtBjuyxWHnlbMA3BDc9qlLeAxpSMf19yADlR88NHeoKLYnmfmjvqFBcE8rRnAPJRkFJrQ4VfsWUj9/xAcwB41lzdhi4gHykLkgZqhv7IJoq52TXEZ3G8UDClfic3ICl9Yjd70/wRZkaxWk6ADMR/XxyXAFepNh9vXuh0Ah8Y62pi74V4fiJyKYbsIWbUvoetRyGfoy7Lx+FgHQDCGCPe6B2h97+CZe2/2N6Icov1N174M2vA4RhCI2m1Itdxp0PMhRE9cAp2Ds6+TywtwY2FQyNkaWnl5+xPIwaD8lyv9zQLlrF9fcBAluJv2MBqC4nX9lhFQLuOhWyJM+pugYXX3RMC1mVS3w8+cp9VYJ28i3Me0ZPubIM9k0KsOnAMSFlD6ZwxvaotP4PAfwS2hjc8wV+KA6RocldHnMJVedAzdwI3LeiC+bE3EuD0wEVDW9OUDQyBJpyZPYtxtQD2hnLi3S6ViZ7STzo52JwryDjam8KQdqTQK48vlUgNXnV9Du5fSyVsJar6OcfVbCTzakuYpc1v6uwMJEhCkH+gNLBqTeqg3RA367aVXkEi1zhxL9Xj3E/I4RDgk3sOnCj6DHK4iCxfiLvHrIwnTAVAs4zlpFOnmvcmD8iGQhAKGf+AAPjoO03OOXsFbb1BxwpfvX9eWRze066M+V2UwfNd/C3yHYQ9AB7bXqQS00vB58mjiAN5emN67k+VMaq7UevNiwRcyTYXufvM44bdd2/U1eife0rIcdcJ/efBVM3k3krfjr8qZ/vb99ThBQF0XU8Cd7Rhtv5dASkb/AeAECG7bCwAA");e=r}else if("s.css"===o.r){n.body=atob("H4sIAAAAAAAAA41W227jNhB971dMNyiQeCNbsuPEkVGjXTRYoNgWRRftS9EHSqQs1hQpkJQvG/jfO6QoWfY6aF92LXIuZ+bMHGYyGsEIbvM7+LkxhgM3yhKhIILS2jqdTP4JJ+OCo6E/NXi85rZssnGuqt5iYkomxCGqlcZIhpQbFTGJTp9fkugBiKyJMYQC2V6L8lltObPPT0+z3xlFp088Z9KwFD7++gf8+PG3T7CdjWMYTfDuFTK1jwz/wuU6xd+aMh3h0fKIH/RwDwRecyWUTuFm+tPsZR4vLdvbiLJcaWK5kqlUkgVzF47km7VWjaToMXt5fHieL0FwyaKS8XVpU0jGD6xaQqGkdYkRVzx+7k8KUnFxSOFPpimRZAkV2Uc7Tm2ZwsOzdnbhK4nj79y1XnOJMYA0Vi2hJpT6Wub1Hk3q/RKOcGO5FQxeBzmT8dTFat2xYmtV5Z2wlJtc1a6WM4gLZ04EX8vIMFGkUAi2R1boEnxH/FUK2GrLtEs6LsQeg1BuakEOrb0/tyQzeFErw30DQTOBrdyy5Xn3KCHx9Ll3SdOMFUqz++6TFJgJA+UIE7Om8O7d8pQObQQbOPfWghHtqLZld+tKFYpgBMEK254aTFMO4Xuag0MkSMbE8DYTKt9cED0dP81d03pK4q7rYc50sEOmjBKcwk3ySOIFDkzeaONmrla8b6fLG0rFzGdDcGollqpEYxHpl4hLyvZoggSp+gTH1YhYBrgSP1ZnvS+KAlGcDz6omuTcHryz71GalyzfMPr+rClvB+r2oa3/Shwf4v1FqX3aZFDVtHVV9ZCFteY4ju7fyLIKzyzDOKKppEHvQvsdcT9657AZxI9RC5LlRVwk8C2vUH4ske1AmFoOuj6e+padVrr97uvy34FUq4k0NdHMRQrMd7leph8e5x/6Y0TUXe1K7ljsJoVQ3mANc8c2kbxqpQccqsT4sSMauCy49G59R7j0IxnG8wg/bNih0KRiBtqK3ADhfx4kbhdqgEYJtux29hhTtr5Dn2O7S+M8X1mnciurV5amBdfGRnnJBcVdydb3wcxUGG142ynJLnQrUwJZ2jJteU5EJxxY+8UMsoI+kVknJVGl3FAIv6yoPJRrlgf9UDtfW8UoJ7dDwVygAN6hx1VFe3SUXdOuIIp+a6JFvR+M2n/MVme5glTasi3/duYQTEbwC9nguoEtGcw0hdYZ1gpLB4kwPI34Kvkc7S1GhglEybInoRpycA832Wb1lhidScRV/wuWQt1BIFzdp7n0y9q/j+1rEQ/Cfs350DdBicsEktvuxP/gtK3/0nBF+bYHGgAECKeMxumF19vhvglSu78Bul9ft+eE+Qre4bPakpy7rXnj4eNDhcbofpk9LuYekp0mtTfcJYt4YLnoglc2iU98tB0MT7nrRhL65RXRmev5sCn+6Y+DuFZifslslyXD8TFRXr2xoEcUj7qxf9lDzb7PGqRc/n2+Qsk4cSt0PC3+65U/a0J13XqcRMLl7fs6c6Cu99M0FeJ363v5LB6/+RdfNleadQoAAA==");e="text/css"}else if("status"===o.r){n.body=atob("H4sIAAAAAAAAA5VSy1LDIBT9FSYr7dg8Fs64SFm5cnR0xoVrAqTFBohwk+jfewMtrbaOuoABzuOeC9TAmk4S3jHvV5kmnGe0BodD0Fs5Ki4JM4Jwa1q1xkOixMovhdmTdsqpuinp4wD9AMTYKRG5FvTeMqHMOs/zg7HnTvWgrElMD6nuk5vLHtvgOqEPVsgEaNwk5BkYHCBlWkvrIvRHa6HGfZNt905woLZZcttlX0DgM1YR7a5PAA1ViYdNDOgJWME+rsjWFduXTV00WA0FGCVcaQjRq/JshmO3eG07uxObKEB+9Duyi6xz2bu/ZNfWOTv9Fr/6R/zo+INT9T14nP3Q08XCjtI5he9azPtQKajG1H7ih49DnXy78xcZGuLHYTD4/NVnlyiP8Ceakyg41gIAAA==");e=c}else if("status.js"===o.r){n.body=atob("H4sIAAAAAAAAA4VX73LbNhL/3DwFhfhkIKQoUmmbsUhQ7aVJ05uk6dS6uQ8ezZkmIZG1RDIEpNgj8bX6An2x2wVJiZLlXpzEC+CH3cX+53YplPGFX/qqDHwVG1G+lEWYcfKaBL/myniE4/ss/5r5QxUH8F8ZXHpRnkll3HHKeLDdhKWhuOLBF0kVs9MsE+WH6aePnBBPUSIH0SomzILTlralelwKG0TlJScvHcchlkbGGQA1BRJbcpXHoqULZ0+lB9I9bO7JNJvnLS0VYZWHekY8lI9ZBPoGW1U+btM5VbvdJk9jw+GcSxUqwe7osbadF33MwzjNFrZtE08spUAGvfqWSsr8q/GuLPOSkiw34lCFhHlo3nnN2Er43JZaDwFUZElcpxqywY3UUpxubJFN6Hn50oadCfn8KxmTz+/fk2eN2gAXpRAZYEsRt9jamh2enz7/9O6/19PfbzY2ns0anHZAB+b4c7uwlyJbqGSS2MWNM7MBY6v8ffogYjpiJjHuy+H9fxIQ2EpDy3eYXKGNQdHJ9fTHaS0VlzO7FMUyjAQl/5DEmuflKlQ/gcWm6UrQTHw1cEFd8fqVtOdvV/FUMqvnMjY+4WOC9dIJMWiabUSpRMxQF2YR0tNyy36fnlPM5MS/g/iHf8TUwDYC6jA6sgPYNrmfSnDDWhVrZUSJiO5FbITKIGat+zm99SVQmbxFPASRkev7GEtsTA9B90QkwTwUWXi3PLjxNDJu3+bZPF0YLy+2KeSm6VZGKrPL/b3b5/MP049ZiR1nux3xU531Uih/mAYQv8LOwpWQN8h1BuZTYCtjBy89OoBEM/mtQaNTLVgrGFO7o6/S26VYpPnxAaSBvQBFrt+9Jt55g6AGA9CAOn4TiAq88VuZRkIa6wIS7/9541OoEnsVPtD9fQspFymGPvpZKIUuKjRT7aLmHZtjs1+rsFTGxfbvYjax1wW6vgK7/bsAMKV7ALMXolaQDc5dOhyzIWwPv3fw7+hbtk88AiWvioH1rZnYG/PSj9ONkcY8yovHwC+CPhLeyBl9Z/xrLWVq/CJzFS5zg/qhkZRizhOlCjkeDv9I6xN7ngYd2h+GATP6RgsnLX6RqmR9B2G0Gl7nm1SoqzdvXv8OMRr8cLRGBga9fsf8YQEdBPSDFoJVMMOusa3r4aEBLUMpOYH2siDBj5DG4ULUvef08FOaGUm+LuHt2k/PoMKHM6i6j5VCrcsMS7/CGBLml7Ewb18YzR9Uab/AZRxcbJUdbhadsldphi+++eYAWKXZB3Q20sujGnkOHD7swUm6SJ6i9/JR6dvKKnlTxHQP7ERj1sRzG6u6HT45d+GcllZ86N2XxlnjY9ydt6nONcv4689SYME/D6rLY9fc0CydHkcdSp1pWnzKb2Z4MoLeULcg1oQErEZ24TsTd1yTHmQZxW6puOMpbEjIqO5JHhSg5uaKD0a8ud3vuz5XE72IRjWfCMX16MrnDqtv5KgDMhZQmCRXZiOv1aDfxxCZ0FYnCaCaEmx8JAxgUCT3uNEBOGId9QWoL/v9HlXB0SsGLoOHmCy3i7VMYJxCVTUDsFZ99erqysrg/S0zCbT0ed5yWHkSGGzr1zgdmRJlmivNX5i8lnuT36jZzBPDlY+Kg2bDFbCXrDpczOBi1lxMa8XwFqv0BPRUkAv4/OAWs7ZxyPGShoGVB67n+Fz0+40a4czfKyRQocGAAWW6M44bXkOH1XEInFEKDDZwW4/sdqehwO5KEd5XVdXYDh7bo3G3Mx38hM8SJ2Em2vcUrQVhZIp4W7u9yIbe+QHqjaTCcvAHZkCc6uYg3heMc/wFpoadqLtlTc+gIOw6QGvBCRQf0rxoNWlSCfbqyF55tWmos0+mfh9+OzgO7nZuZ7fwOT0wc+3lCTPYYbvdqHMjBSNFy3Us4GVMM1gcA45Zjp6whJ39PaR6U0iwVEddTzELB9/dDhduvej3u9zpIRkhgNoE2+32tGDH3u6gRl3YCHCO36JEwGWT7qASlWYDw7jImBV3x45bKJOGnp04udhG2JtrT4O/jjt6s60dWE7IPM/U4KuA6q7Gd/ky9nAsrS622YTchdH9oszXWTx+KWL8qQ9Jt/PobtFW13mqSNBOHHo2iHAYPmkWh4ZFi1eu47Dn+0qnt01I/+XD6I37bavhcrebTsirV3p5eq1pSE0X3df16iidzC8V80rqtD0JWhazSuq2a2hRrKqiUEVY77b4aZnDcCr0hxSExfNfYzh8qTWMfJn+QDWobqdCSpgYDoPnmYkXP4eqyouA89t/XtfFI2LV/wCY0DmXCw8AAA==");e=r}else if("history"===o.r){n.body=atob("H4sIAAAAAAAACmWNOw7CMBBEr2K5giJY6TdbUdHQcAH/AoscHLybKLk9IgSElGaKefOBQKPyyTI3uk2TatNUddlVPieN8AfFv1mtEcS6FBGkIEj4YeWuGi/UxY15HqQfZGMfI/tCvVB+gFnGXA6zotBwdSMWBLM+mUDjVz8dLPF54p0W65ZsLvPhznoPZuUvUGxSH9cAAAA=");e=c}else if("history.js"===o.r){n.body=atob("H4sIAAAAAAAAClWSUW/TMBDHv4p3KsgmabZR8dLUqYAx7WFs0hqeooi57qW18OxiXzZVWb47Sgqok/xwtny/++tndxaJRVnVufYuEltLkkX3O3KI052JBCIzzmG4Kb/fSlhQKBa0YdrbuFdOzoo7z4ZrPhwW57QpFucUCujzZxWYlioenGYDcNgHeYrNKRw603B6fXWttVJGUoQiILXBsTUXuWk4kFpP//JBSqXJPGOp1mIEYqqkelGG2BbpSpHiPx5uVwksg9y9NxIS4yKNHJX5X2KYdsajVNlGkRKZRbel3cnEHm1EZhr+6WJ2JqXKtN+8SRROXUDe+MCR+YbFLPpAnFMahCxCdVFPqbqoxTGmO3qD1Ek+rEQ+jg6tilFCYwiKSdf48KSoNE/IHb6wK0XIL3H2AUdOP8p9FMnYGelgUYL21of5pMPqsl7CNiA6mEPADfQD8Xh839K+JXZ/B/P/9fU1vAEWk25Vfi6//VyVDxVWH+t6mQXcW6WRA+OtI2PZuyggBfgXJYHjU586SaTr+14r0jtOohs+lLeYYQg+cBLpqT7q+1xzkX79ssr2bdxxLfo/Hd7yEYwCAAA=");e=r}else if("config"===o.r){n.body=atob("H4sIAAAAAAAAA5VWa2/iOBT9K1ZWo2mlCQmGqSoEltgOnTIqUBW689k4JvHi2KntwLC/fp0XD9PSmQ9B5Pje6+NzH04/YhvAogFZxT4HhGOtB4agR4kjJuJWq9UPrAXqH8yANjtOBxHTGce7npCCVsuVs2cIWHqVzUoK42v2H+21W5Cm6G42mcymYD5aLMbT7/M6tMFLThvvFBDiWUzZJ0LPNGZSFP/6mnJKTMEhRn2ZGYuDDeY5HcxHbWQfF4QWhC7YsWDHBbsW7PaDaodm75rQtn0bon+Gi5IDE1leUthgA4pzDToIfGrILhQWekUVWFGqCyC88SHsgYNbhHd7t7UK1j+TI+FS0w4RhH54c+wiWJwY16nSLSiFc7UvwlxIwPR+/B381dcZFmU+mY1TvKAPk3EsyEgUZlEpCsdLyhttzC6jA5JQsl7KX8UGVCAwmwaz+/t+UFvWck1xSk9VFfu1iYyok/XUQshNEponlPMdkLmxMTTQGSWnMWUJF/J1EQjBSiqA7buI7SkDEH5pf4ElmObcsIzTJvCjjJuoDhFJnPoL0Uz4JMEipqcLbTTkW7zTZ6zvbFqU5CBlIjdVrRwYW3Cfb/u/8RmLDVWm1vwdsZnY7Pf4G5N1noFE5qrYoFhervero5SqmAqy+50UKvVeDmeWk2JRfYSIGsy4buqZf7Wy5WmK1c7mSW6DxFpaLWqoLjW7wSppCk6nZf16h+IO6qBvlntd62gynL4MH8Fk9m30R2U8KxP8GxKkoU/S6EyFC5Sensd3I/A4nowXf0TpSTFCAWcpM05ZtH2Lnk2C9xncPYyGT6P5AjzMXp4/nrXHJBYspSCjisnI7ULoW9xpANhFsJs4tQ9RGzrYLbp1kBt04yBd5EbqoI6DQORG9tuI5NrIFFy1a+LXjgXcW8DaQl/vGxNUA7GSIEGmOL8qGrrXTEejmrKGPqmauAznJMnKo5sc9cIQ+OB0kR4tNk30YFsUEJkLN+N2J3GY/ckpB3hEAsA3aMCLPOApkbPAB1JvBLe04AmvahbT15wKwzC/NKOsu37dD5BqQAKbJrfkq/C1h13cl3xzReBfLZC92S0nrumlXqnvS+/oeBpvaMV6mRtz+EqwMDr6Fjq7cMuPm+H02/zMyH5O1eEPF/3JDsUIlMoepNrKm2CRYw5kPVwtu6X6IIQUhDOyHnzeMhHJbUtmVFx5gXf9uY5ZX5Q/6fJl7DUHqX41USwzSNHXH/rKsyL5RIoVi1v/aq9okWr5f3zAkwEpCgAA");e=c}else if("config.js"===o.r){n.body=atob("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");e=r}else{n.body=atob("H4sIAAAAAAAAA6VUTW/bMAy991do2qXBanu9DY2lHroCw64DdlckJlarSJpIxwiG/vdJttPWwT4K7CKD75GPj5Tt9p0Jmo4ROto72ZaTOeV3Arxs90CK6U4lBBI9batPsiVLDuS9i8li20zRlOjVHsTBwhBDIqaDJ/Ak+GANdcLAwWqoxuDKektWuQq1ciCuubxojT0w7RSioBDlGFojZnnFugRbwTuiiDdNMwxDDaMDoIceyfc1QsNnVyeMtRiVLzI8wc4Gz2XbFCg/1Nwykxitn1tjLFzGT+d4IDjQVFKtR5JtiJTF2EG5HgT/yOVd8Fu7Y++v22biSp+xaKG2GFJtUC5j2Vofe2LlMkRSxoZpo2pchNpUSIp6zPcB+hGMmJ8nAcz6Tm3AsW1Ii/xTg2qk5bcRbpspWnqo5lsrLXX1IvK3Of7pu7NIIR1fjJ75POOfjX6Z8Lc6nWX+y6qebvJPTpf0y0aByPrdm3c6ySzftNku6mQjyZyBxD7ff2eCDdabMNQuaFXerToku7O+tl673gBe8sK4LiDx1doBMZOL8kfd73PTEdAJFMG9g4Jkctt7XaQuYfWTJaA+eWbqRVam1uxprFYxgjd3nXXmvNbUm2CO9auMV3UJfnzFs4qDSqxgy158mjrbxxqTznyZ/JYBu2H8NgnOPjCoE0SnNFzyskJ+xXP668a4Wj+tL8Zx8TctnPWPuSJzWchlniMdHWAHQHyEyy/muTXHOmN8NjAFi3YZWK3HEbP9+gGzdv7op9v7BQTcLZVUBQAA");e=c;n.code=404}n.headers=[["Content-Type",e]];if(useGzip){n.headers.push(["Content-Encoding","gzip"])}}catch(err){log("server error: "+err);n.code=500}n.send()});Timer.set(1e4,true,loop),loop();//end